package com.example.medinvento

import androidx.compose.material.icons.filled.Search
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import java.util.Calendar
import androidx.compose.material3.ExperimentalMaterial3Api


data class Medicine(
    val city: String,
    val storeName: String,
    val name: String,
    val batch: String,
    val stock: Int,
    val expiry: String   // format: MM/YYYY
)

enum class ExpiryStatus { EXPIRED, WARNING, SAFE }

@Composable
fun InventoryScreen(medicines: List<Medicine>) {
    var selectedCity by remember { mutableStateOf<String?>(null) }
    var selectedStore by remember { mutableStateOf<String?>(null) }

    val byCity = medicines.groupBy { it.city }

    when {
        selectedCity == null -> {
            CityListScreen(
                byCity = byCity,
                onCityClick = { city ->
                    selectedCity = city
                    selectedStore = null
                }
            )
        }

        selectedStore == null -> {
            val medsInCity = byCity[selectedCity].orEmpty()
            StoreListScreenInCity(
                cityName = selectedCity!!,
                medicinesInCity = medsInCity,
                onBack = {
                    selectedCity = null
                    selectedStore = null
                },
                onStoreClick = { store ->
                    selectedStore = store
                }
            )
        }

        else -> {
            val medsInStore = medicines.filter {
                it.city == selectedCity && it.storeName == selectedStore
            }
            StoreDetailScreen(
                cityName = selectedCity!!,
                storeName = selectedStore!!,
                medicines = medsInStore,
                onBack = { selectedStore = null }
            )
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CityListScreen(
    byCity: Map<String, List<Medicine>>,
    onCityClick: (String) -> Unit
) {
    var showSearch by remember { mutableStateOf(false) }
    var query by remember { mutableStateOf("") }

    val allCities = byCity.keys.sorted()
    val filteredCities = allCities.filter { city ->
        query.isBlank() || city.contains(query, ignoreCase = true)
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("Cities") },
                actions = {
                    IconButton(onClick = { showSearch = !showSearch }) {
                        Icon(Icons.Filled.Search, contentDescription = "Search city")
                    }
                }
            )
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
        ) {
            if (showSearch) {
                OutlinedTextField(
                    value = query,
                    onValueChange = { query = it },
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(16.dp),
                    label = { Text("Search city") },
                    singleLine = true
                )
            }

            LazyColumn(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(horizontal = 16.dp, vertical = 8.dp)
            ) {
                filteredCities.forEach { city ->
                    val medsInCity = byCity[city].orEmpty()
                    val stores = medsInCity.map { it.storeName }.distinct().size
                    val totalMeds = medsInCity.size
                    val expiredCount = medsInCity.count { isExpired(it.expiry) }

                    item {
                        Card(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(vertical = 8.dp)
                                .clickable { onCityClick(city) }
                        ) {
                            Column(Modifier.padding(12.dp)) {
                                Text(city, style = MaterialTheme.typography.titleLarge)
                                Spacer(Modifier.height(4.dp))
                                Text("Stores: $stores")
                                Text("Medicines: $totalMeds")
                                Text("Expired: $expiredCount")
                            }
                        }
                    }
                }
            }
        }
    }
}


@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun StoreListScreenInCity(
    cityName: String,
    medicinesInCity: List<Medicine>,
    onBack: () -> Unit,
    onStoreClick: (String) -> Unit
) {
    var showSearch by remember { mutableStateOf(false) }
    var query by remember { mutableStateOf("") }

    val byStore = medicinesInCity.groupBy { it.storeName }

    val filteredStores = byStore.keys.filter { store ->
        query.isBlank() || store.contains(query, ignoreCase = true)
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text(cityName) },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Filled.ArrowBack, contentDescription = "Back")
                    }
                },
                actions = {
                    IconButton(onClick = { showSearch = !showSearch }) {
                        Icon(Icons.Filled.Search, contentDescription = "Search store")
                    }
                }
            )
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
        ) {
            if (showSearch) {
                OutlinedTextField(
                    value = query,
                    onValueChange = { query = it },
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(16.dp),
                    label = { Text("Search store") },
                    singleLine = true
                )
            }

            LazyColumn(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(horizontal = 16.dp)
            ) {
                filteredStores.forEach { storeName ->
                    val medsInStore = byStore[storeName].orEmpty()
                    val total = medsInStore.size
                    val expiredCount = medsInStore.count { isExpired(it.expiry) }

                    item {
                        Card(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(vertical = 8.dp)
                                .clickable { onStoreClick(storeName) }
                        ) {
                            Column(Modifier.padding(12.dp)) {
                                Text(storeName, style = MaterialTheme.typography.titleLarge)
                                Spacer(Modifier.height(4.dp))
                                Text("Medicines: $total")
                                Text("Expired: $expiredCount")
                            }
                        }
                    }
                }
            }
        }
    }
}


@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun StoreDetailScreen(
    cityName: String,
    storeName: String,
    medicines: List<Medicine>,
    onBack: () -> Unit
) {
    var showSearch by remember { mutableStateOf(false) }
    var query by remember { mutableStateOf("") }

    val filteredMeds = medicines.filter { med ->
        query.isBlank() || med.name.contains(query, ignoreCase = true)
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("$storeName – $cityName") },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Filled.ArrowBack, contentDescription = "Back")
                    }
                },
                actions = {
                    IconButton(onClick = { showSearch = !showSearch }) {
                        Icon(Icons.Filled.Search, contentDescription = "Search medicine")
                    }
                }
            )
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .padding(16.dp)
        ) {
            if (showSearch) {
                OutlinedTextField(
                    value = query,
                    onValueChange = { query = it },
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(bottom = 12.dp),
                    label = { Text("Search medicine") },
                    singleLine = true
                )
            }

            val expiredCount = medicines.count { isExpired(it.expiry) }
            Text("Medicines: ${medicines.size}")
            Text("Expired: $expiredCount")
            Spacer(Modifier.height(16.dp))

            LazyColumn {
                items(filteredMeds) { med ->
                    val status = getExpiryStatus(med.expiry)
                    val bgColor = when (status) {
                        ExpiryStatus.EXPIRED -> MaterialTheme.colorScheme.errorContainer
                        ExpiryStatus.WARNING -> MaterialTheme.colorScheme.tertiaryContainer
                        ExpiryStatus.SAFE -> MaterialTheme.colorScheme.primaryContainer
                    }

                    Card(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(vertical = 4.dp),
                        colors = CardDefaults.cardColors(containerColor = bgColor)
                    ) {
                        Column(Modifier.padding(12.dp)) {
                            Text(med.name, style = MaterialTheme.typography.titleMedium)
                            Text("Batch: ${med.batch}")
                            Text("Stock: ${med.stock}")
                            Text("Expiry: ${med.expiry}")
                        }
                    }
                }
            }
        }
    }
}


fun isExpired(expiry: String): Boolean
 {
    return try {
        val parts = expiry.split("/")
        if (parts.size != 2) return false

        val month = parts[0].toIntOrNull() ?: return false
        val year = parts[1].toIntOrNull() ?: return false

        val cal = Calendar.getInstance()
        val currentYear = cal.get(Calendar.YEAR)
        val currentMonth = cal.get(Calendar.MONTH) + 1

        year < currentYear || (year == currentYear && month < currentMonth)
    } catch (e: Exception) {
        false
    }
}

fun getExpiryStatus(expiry: String): ExpiryStatus
 {
    return try {
        val parts = expiry.split("/")
        if (parts.size != 2) return ExpiryStatus.SAFE

        val month = parts[0].toIntOrNull() ?: return ExpiryStatus.SAFE
        val year = parts[1].toIntOrNull() ?: return ExpiryStatus.SAFE

        val cal = Calendar.getInstance()
        val currentYear = cal.get(Calendar.YEAR)
        val currentMonth = cal.get(Calendar.MONTH) + 1

        val monthsLeft = (year - currentYear) * 12 + (month - currentMonth)

        when {
            monthsLeft < 0 -> ExpiryStatus.EXPIRED
            monthsLeft <= 3 -> ExpiryStatus.WARNING
            else -> ExpiryStatus.SAFE
        }
    } catch (e: Exception) {
        ExpiryStatus.SAFE
    }
}
